{% extends "base.html" %}

{% block title %}Dashboard - WireGuard Manager{% endblock %}

{% block content %}
<h1>Dashboard</h1>

{% if wg_service_status %}
<div class="card" style="margin-bottom: 2rem; {% if wg_service_status.status == 'healthy' %}background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); color: white;{% elif wg_service_status.status == 'unhealthy' %}background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white;{% else %}background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); color: white;{% endif %}">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2 style="margin: 0; color: white;">üõ°Ô∏è WireGuard Service Status</h2>
            <p style="margin: 0.5rem 0 0 0; font-size: 1.1rem; opacity: 0.9;">
                {% if wg_service_status.status == 'healthy' %}
                    ‚úÖ Service Running & Healthy
                {% elif wg_service_status.status == 'unhealthy' %}
                    ‚ö†Ô∏è Service Issues Detected
                {% else %}
                    ‚ùì Status Unknown
                {% endif %}
            </p>
        </div>
        <div style="text-align: right;">
            <div style="font-size: 0.9rem; opacity: 0.9;">
                <div>Service: {% if wg_service_status.service_active %}‚úÖ Active{% else %}‚ùå Inactive{% endif %}</div>
                <div>Interface: {% if wg_service_status.interface_up %}‚úÖ Up{% else %}‚ùå Down{% endif %}</div>
                <div>Active Peers: {{ wg_service_status.peer_count }}</div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="stats-grid">
    <div class="stat-card">
        <h3>Total Clients</h3>
        <div class="value">{{ total_clients }}</div>
    </div>
    
    <div class="stat-card">
        <h3>Active Clients</h3>
        <div class="value" style="color: #27ae60;">{{ active_clients }}</div>
    </div>
    
    <div class="stat-card">
        <h3>Connected Now</h3>
        <div class="value" style="color: #3498db;">{{ connected_clients }}</div>
    </div>
    
    <div class="stat-card">
        <h3>Expired</h3>
        <div class="value" style="color: #e74c3c;">{{ expired_clients }}</div>
    </div>
    
    <div class="stat-card">
        <h3>Total Data</h3>
        <div class="value" style="font-size: 1.5rem;">{{ total_data }}</div>
    </div>
    
    <div class="stat-card">
        <h3>Download</h3>
        <div class="value" style="font-size: 1.5rem;">{{ total_rx }}</div>
    </div>
    
    <div class="stat-card">
        <h3>Upload</h3>
        <div class="value" style="font-size: 1.5rem;">{{ total_tx }}</div>
    </div>
</div>

<div class="card">
    <div class="flex-between">
        <h2>Recent Activity</h2>
        <a href="{{ url_for('audit.index') }}" class="btn btn-secondary btn-sm">View All</a>
    </div>
    
    {% if recent_activity %}
    <table>
        <thead>
            <tr>
                <th>Time</th>
                <th>Action</th>
                <th>User</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in recent_activity %}
            <tr>
                <td>{{ entry.timestamp[:19] }}</td>
                <td><strong>{{ entry.action.replace('_', ' ').title() }}</strong></td>
                <td>{{ entry.user }}</td>
                <td>
                    {% if entry.details %}
                        {% for key, value in entry.details.items() %}
                            {{ key }}: {{ value }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="text-align: center; color: #7f8c8d; padding: 2rem;">No recent activity</p>
    {% endif %}
</div>

<div class="card">
    <div class="flex-between">
        <h2>Quick Actions</h2>
    </div>
    
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <a href="{{ url_for('clients.add') }}" class="btn btn-primary">+ Add New Client</a>
        <a href="{{ url_for('profiles.add') }}" class="btn btn-success">+ Create Profile</a>
        <a href="{{ url_for('clients.index') }}" class="btn btn-secondary">View All Clients</a>
        <a href="{{ url_for('usage.index') }}" class="btn btn-secondary">Usage Statistics</a>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Auto-refresh stats every 30 seconds
    setInterval(function() {
        fetch('{{ url_for("dashboard.api_stats") }}')
            .then(response => response.json())
            .then(data => {
                // Update connected clients count
                document.querySelectorAll('.stat-card')[2].querySelector('.value').textContent = data.connected_clients;
            });
    }, 30000);
</script>
{% endblock %}
